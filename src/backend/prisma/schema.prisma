// Prisma schema for LiDAR Forest Analysis Platform
// PostgreSQL with PostGIS extension for spatial data support

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ============================================================================
// User Management
// ============================================================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  name              String
  role              UserRole  @default(USER)
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  avatarUrl         String?   @map("avatar_url")

  // Password reset
  passwordResetToken     String?   @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")

  // Refresh tokens for JWT
  refreshTokens     RefreshToken[]

  // Relations
  projects          Project[]
  speciesCorrections SpeciesCorrection[]

  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLoginAt       DateTime? @map("last_login_at")

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================================================
// Project Management
// ============================================================================

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)

  // Owner
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Spatial bounds (GeoJSON Polygon stored as JSON, or use PostGIS geometry)
  bounds      Json?         // GeoJSON Polygon for project area

  // Metadata
  metadata    Json?         // Additional project metadata

  // Relations
  files       File[]
  analyses    Analysis[]
  reports     Report[]

  // Timestamps
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

// ============================================================================
// File Management
// ============================================================================

model File {
  id            String     @id @default(uuid())
  name          String     // Original filename
  storagePath   String     @map("storage_path") // Path in storage system
  mimeType      String     @map("mime_type")
  size          BigInt     // File size in bytes
  checksum      String?    // MD5 or SHA256 checksum

  // File type classification
  fileType      FileType   @map("file_type")

  // Processing status
  status        FileStatus @default(PENDING)
  processingError String?  @map("processing_error")

  // Spatial metadata (extracted from LiDAR/raster files)
  bounds        Json?      // GeoJSON bounding box
  crs           String?    // Coordinate reference system (e.g., "EPSG:4326")
  pointCount    BigInt?    @map("point_count") // For LiDAR files
  resolution    Float?     // For raster files (meters per pixel)

  // Additional metadata extracted during processing
  metadata      Json?

  // Relations
  projectId     String     @map("project_id")
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Files used in analyses
  analysisFiles AnalysisFile[]

  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  processedAt   DateTime?  @map("processed_at")

  @@index([projectId])
  @@index([fileType])
  @@index([status])
  @@map("files")
}

enum FileType {
  LAS         // LAS/LAZ point cloud
  LAZ         // Compressed LAS
  GEOTIFF     // GeoTIFF raster
  SHAPEFILE   // Shapefile (zipped)
  GEOJSON     // GeoJSON vector
  COG         // Cloud Optimized GeoTIFF
  OTHER
}

enum FileStatus {
  PENDING     // Awaiting processing
  PROCESSING  // Currently being processed
  READY       // Processed and ready for analysis
  ERROR       // Processing failed
}

// ============================================================================
// Analysis Management
// ============================================================================

model Analysis {
  id            String         @id @default(uuid())
  name          String
  type          AnalysisType

  // Analysis parameters (type-specific configuration)
  parameters    Json?

  // Processing status
  status        AnalysisStatus @default(PENDING)
  progress      Float          @default(0) // 0-100 percentage
  progressMessage String?      @map("progress_message")
  errorMessage  String?        @map("error_message")

  // Processing stage tracking (Sprint 7-8)
  processingStage ProcessingStage @default(QUEUED) @map("processing_stage")

  // Spatial bounds for analysis area
  bounds        Json?          // GeoJSON Polygon/MultiPolygon

  // Results
  results       Json?          // Analysis results as JSON
  resultFiles   ResultFile[]   // Generated result files

  // Statistics
  statistics    Json?          // Summary statistics

  // Processing metadata
  startedAt     DateTime?      @map("started_at")
  completedAt   DateTime?      @map("completed_at")
  processingTime Int?          @map("processing_time") // Duration in seconds

  // Relations
  projectId     String         @map("project_id")
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Input files
  analysisFiles AnalysisFile[]

  // Reports generated from this analysis
  reports       Report[]

  // Tree detections from this analysis (Sprint 13-14)
  treeDetections TreeDetection[]

  // Timestamps
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([type])
  @@index([status])
  @@map("analyses")
}

enum AnalysisType {
  TREE_DETECTION
  CANOPY_HEIGHT
  BIOMASS_ESTIMATION
  SPECIES_CLASSIFICATION
  CHANGE_DETECTION
  TERRAIN_ANALYSIS
  FOREST_METRICS
}

enum AnalysisStatus {
  PENDING     // Queued for processing
  PROCESSING  // Currently running
  COMPLETED   // Successfully completed
  FAILED      // Processing failed
  CANCELLED   // Cancelled by user
}

// Processing stage enum for detailed pipeline tracking (Sprint 7-8)
enum ProcessingStage {
  QUEUED                  // Waiting in queue
  GROUND_CLASSIFICATION   // Ground point classification stage
  HEIGHT_NORMALIZATION    // Height normalization stage
  TREE_DETECTION          // Tree detection stage
  METRICS_EXTRACTION      // Metrics extraction stage
  COMPLETED               // Processing completed
  FAILED                  // Processing failed
}

// Junction table for Analysis-File many-to-many relationship
model AnalysisFile {
  id         String   @id @default(uuid())
  analysisId String   @map("analysis_id")
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  fileId     String   @map("file_id")
  file       File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([analysisId, fileId])
  @@index([analysisId])
  @@index([fileId])
  @@map("analysis_files")
}

// Result files generated by analyses
model ResultFile {
  id          String   @id @default(uuid())
  name        String
  storagePath String   @map("storage_path")
  mimeType    String   @map("mime_type")
  size        BigInt
  fileType    String   @map("file_type") // e.g., "geojson", "geotiff", "csv", "pdf"

  // Relation
  analysisId  String   @map("analysis_id")
  analysis    Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")

  @@index([analysisId])
  @@map("result_files")
}

// ============================================================================
// Job Queue Tracking (optional - for BullMQ job status persistence)
// ============================================================================

model JobLog {
  id          String    @id @default(uuid())
  jobId       String    @map("job_id")
  queueName   String    @map("queue_name")
  jobType     String    @map("job_type")
  status      JobStatus
  data        Json?
  result      Json?
  error       String?
  attempts    Int       @default(0)

  // Timing
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@index([jobId])
  @@index([queueName])
  @@index([status])
  @@map("job_logs")
}

enum JobStatus {
  PENDING
  ACTIVE
  COMPLETED
  FAILED
  DELAYED
  PAUSED
}

// ============================================================================
// Tree Detection (Sprint 13-14)
// ============================================================================

model TreeDetection {
  id                String   @id @default(uuid())

  // Relation to analysis
  analysisId        String   @map("analysis_id")
  analysis          Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Spatial coordinates
  x                 Float    // X coordinate (eastings)
  y                 Float    // Y coordinate (northings)
  z                 Float    // Z coordinate (elevation)

  // Tree measurements
  height            Float    // Tree height in meters
  crownDiameter     Float    @map("crown_diameter") // Crown diameter in meters
  dbh               Float?   // Diameter at breast height in meters (optional)

  // Species classification (Sprint 13-14)
  speciesCode       String?  @map("species_code")     // Species code (e.g., 'PSME')
  speciesName       String?  @map("species_name")     // Species scientific name
  speciesConfidence Float?   @map("species_confidence") // Classification confidence (0-1)

  // Biomass and carbon estimates
  biomass           Float?   // Above-ground biomass in kg
  carbon            Float?   // Carbon content in kg

  // Species corrections (Sprint 15-16)
  speciesCorrections SpeciesCorrection[]

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([analysisId])
  @@index([speciesCode])
  @@map("tree_detections")
}

// ============================================================================
// Species Correction (Sprint 15-16)
// ============================================================================

model SpeciesCorrection {
  id                String        @id @default(uuid())

  // Relation to tree detection
  treeDetectionId   String        @map("tree_detection_id")
  treeDetection     TreeDetection @relation(fields: [treeDetectionId], references: [id], onDelete: Cascade)

  // Correction details
  predictedSpecies  String        @map("predicted_species")  // Original predicted species code
  correctedSpecies  String        @map("corrected_species")  // User-corrected species code
  confidenceWas     Float         @map("confidence_was")     // Original confidence before correction

  // User who made the correction
  userId            String        @map("user_id")
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")

  @@index([treeDetectionId])
  @@index([userId])
  @@index([predictedSpecies])
  @@index([correctedSpecies])
  @@map("species_corrections")
}

// ============================================================================
// Report Generation (Sprint 11-12)
// ============================================================================

model Report {
  id          String       @id @default(uuid())
  analysisId  String       @map("analysis_id")
  analysis    Analysis     @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  projectId   String       @map("project_id")
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      ReportStatus @default(QUEUED)
  format      String       // 'pdf', 'excel', or 'both'
  pdfPath     String?      @map("pdf_path")
  excelPath   String?      @map("excel_path")
  options     Json         // ReportOptions configuration
  error       String?      // Error message if generation failed
  createdAt   DateTime     @default(now()) @map("created_at")
  completedAt DateTime?    @map("completed_at")

  @@index([analysisId])
  @@index([projectId])
  @@index([status])
  @@map("reports")
}

enum ReportStatus {
  QUEUED
  GENERATING
  COMPLETED
  FAILED
}

// ============================================================================
// Organization & Team Management (Sprint 43-48)
// ============================================================================

model Organization {
  id              String    @id @default(uuid())
  name            String
  slug            String    @unique  // URL-friendly identifier
  description     String?
  logoUrl         String?   @map("logo_url")
  website         String?

  // Billing/Plan
  plan            OrgPlan   @default(FREE)
  planExpiresAt   DateTime? @map("plan_expires_at")

  // Settings
  settings        Json?     // Organization-level settings

  // SSO Configuration (Enterprise)
  ssoEnabled      Boolean   @default(false) @map("sso_enabled")
  ssoProvider     String?   @map("sso_provider")  // 'saml', 'oidc'
  ssoConfig       Json?     @map("sso_config")    // SSO configuration details

  // Members and Projects
  members         OrganizationMember[]
  projects        OrgProject[]
  invitations     Invitation[]
  activityLogs    ActivityLog[]

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([slug])
  @@map("organizations")
}

enum OrgPlan {
  FREE        // Basic plan
  STARTER     // Small teams
  PROFESSIONAL // Professional features
  ENTERPRISE  // Enterprise with SSO, SLA
}

model OrganizationMember {
  id              String   @id @default(uuid())

  // Relations
  organizationId  String   @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String   @map("user_id")

  // Role within organization
  role            OrgRole  @default(MEMBER)

  // Status
  status          MemberStatus @default(ACTIVE)

  // Timestamps
  joinedAt        DateTime @default(now()) @map("joined_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Comments and activities by this member
  comments        Comment[]
  annotations     Annotation[]
  activityLogs    ActivityLog[]

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

enum OrgRole {
  OWNER     // Full control, billing, can delete org
  ADMIN     // Can manage members, settings
  MEMBER    // Standard member (can create/edit own work)
  EDITOR    // Can create/edit projects and analyses
  VIEWER    // Read-only access
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Organization-owned projects (shared projects)
model OrgProject {
  id              String   @id @default(uuid())

  // Relations
  organizationId  String   @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectId       String   @map("project_id")

  // Sharing settings
  accessLevel     ProjectAccessLevel @default(PRIVATE)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([organizationId, projectId])
  @@index([organizationId])
  @@index([projectId])
  @@map("org_projects")
}

enum ProjectAccessLevel {
  PRIVATE   // Only explicit members
  ORG_READ  // All org members can view
  ORG_EDIT  // All org members can edit
  PUBLIC    // Anyone with link (view only)
}

// Invitations for new members
model Invitation {
  id              String   @id @default(uuid())

  // Organization
  organizationId  String   @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Invitation details
  email           String
  role            OrgRole  @default(MEMBER)
  token           String   @unique

  // Status
  status          InviteStatus @default(PENDING)

  // Invited by
  invitedBy       String   @map("invited_by")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  expiresAt       DateTime @map("expires_at")
  acceptedAt      DateTime? @map("accepted_at")

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@map("invitations")
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// Comments & Annotations (Sprint 43-48)
// ============================================================================

model Comment {
  id              String   @id @default(uuid())
  content         String   // Comment text (supports markdown)

  // Author (organization member)
  authorId        String   @map("author_id")
  author          OrganizationMember @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Target - what the comment is on
  targetType      CommentTargetType @map("target_type")
  targetId        String   @map("target_id")

  // Thread support (replies)
  parentId        String?  @map("parent_id")
  parent          Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")

  // Mentions
  mentions        CommentMention[]

  // Status
  isEdited        Boolean  @default(false) @map("is_edited")
  isDeleted       Boolean  @default(false) @map("is_deleted")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([authorId])
  @@index([targetType, targetId])
  @@index([parentId])
  @@map("comments")
}

enum CommentTargetType {
  PROJECT
  ANALYSIS
  REPORT
  FILE
}

// @mentions in comments
model CommentMention {
  id              String   @id @default(uuid())

  commentId       String   @map("comment_id")
  comment         Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Mentioned user (by userId)
  mentionedUserId String   @map("mentioned_user_id")

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([commentId])
  @@index([mentionedUserId])
  @@map("comment_mentions")
}

// 3D Viewer Annotations
model Annotation {
  id              String   @id @default(uuid())

  // Author
  authorId        String   @map("author_id")
  author          OrganizationMember @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Target analysis/project
  analysisId      String   @map("analysis_id")

  // Annotation content
  title           String
  description     String?

  // 3D position and camera state
  position        Json     // {x, y, z} coordinates in scene
  cameraState     Json?    @map("camera_state") // Camera position/rotation for restoring view

  // Visual properties
  color           String?  // Annotation marker color
  icon            String?  // Icon type

  // Visibility
  isPublic        Boolean  @default(true) @map("is_public")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([authorId])
  @@index([analysisId])
  @@map("annotations")
}

// ============================================================================
// Activity Log & Notifications (Sprint 43-48)
// ============================================================================

model ActivityLog {
  id              String   @id @default(uuid())

  // Organization context
  organizationId  String   @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Actor (who performed the action)
  actorId         String?  @map("actor_id")
  actor           OrganizationMember? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  // Action details
  action          ActivityAction
  targetType      String   @map("target_type") // 'project', 'analysis', 'member', etc.
  targetId        String?  @map("target_id")
  targetName      String?  @map("target_name") // Human-readable name

  // Additional context
  metadata        Json?    // Extra details about the action

  // IP/Device info for audit
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")

  // Timestamp
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([organizationId])
  @@index([actorId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("activity_logs")
}

enum ActivityAction {
  // Member actions
  MEMBER_JOINED
  MEMBER_INVITED
  MEMBER_REMOVED
  MEMBER_ROLE_CHANGED

  // Project actions
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_DELETED
  PROJECT_SHARED

  // Analysis actions
  ANALYSIS_CREATED
  ANALYSIS_COMPLETED
  ANALYSIS_FAILED
  ANALYSIS_DELETED

  // File actions
  FILE_UPLOADED
  FILE_DELETED

  // Report actions
  REPORT_GENERATED
  REPORT_DOWNLOADED

  // Comment actions
  COMMENT_ADDED
  COMMENT_EDITED
  COMMENT_DELETED

  // Annotation actions
  ANNOTATION_CREATED
  ANNOTATION_UPDATED
  ANNOTATION_DELETED

  // Organization actions
  ORG_SETTINGS_UPDATED
  ORG_PLAN_CHANGED
}

model Notification {
  id              String   @id @default(uuid())

  // Recipient (by userId)
  userId          String   @map("user_id")

  // Notification content
  type            NotificationType
  title           String
  message         String

  // Link to related resource
  targetType      String?  @map("target_type")
  targetId        String?  @map("target_id")

  // Status
  isRead          Boolean  @default(false) @map("is_read")
  readAt          DateTime? @map("read_at")

  // Email notification
  emailSent       Boolean  @default(false) @map("email_sent")
  emailSentAt     DateTime? @map("email_sent_at")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  MENTION          // @mentioned in comment
  COMMENT_REPLY    // Reply to your comment
  ANALYSIS_COMPLETE // Analysis finished
  ANALYSIS_FAILED  // Analysis failed
  INVITATION       // Invited to organization
  PROJECT_SHARED   // Project shared with you
  ROLE_CHANGED     // Your role was changed
  REPORT_READY     // Report generation complete
}
